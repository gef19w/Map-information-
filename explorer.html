<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>3D World Explorer</title>
  <script src="https://cesium.com/downloads/cesiumjs/releases/1.113/Build/Cesium/Cesium.js"></script>
  <link href="https://cesium.com/downloads/cesiumjs/releases/1.113/Build/Cesium/Widgets/widgets.css" rel="stylesheet" />
  <style>
    html, body, #cesiumContainer {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      font-family: sans-serif;
      overflow: hidden;
    }

    #searchBar {
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255,255,255,0.9);
      padding: 10px 20px;
      border-radius: 25px;
      box-shadow: 0 2px 15px rgba(0,0,0,0.2);
      z-index: 999;
      display: flex;
      gap: 10px;
      align-items: center;
      backdrop-filter: blur(5px);
    }

    #searchInput {
      width: 300px;
      padding: 10px 15px;
      font-size: 1em;
      border: 1px solid #ddd;
      border-radius: 20px;
      outline: none;
    }

    #searchBar button {
      padding: 10px 20px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 20px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s;
    }

    #searchBar button:hover {
      background: #45a049;
    }

    #infoBox {
      position: absolute;
      bottom: 20px;
      left: 20px;
      max-width: 300px;
      background: rgba(255,255,255,0.95);
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 3px 15px rgba(0,0,0,0.2);
      font-size: 0.9em;
      z-index: 999;
      display: none;
      line-height: 1.5;
    }

    #loadingStatus {
      position: absolute;
      top: 80px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 12px 25px;
      border-radius: 25px;
      z-index: 999;
      display: none;
      font-size: 0.9em;
    }

    .cesium-viewer-toolbar {
      top: 80px !important;
    }
  </style>
</head>
<body>
  <div id="cesiumContainer"></div>

  <div id="searchBar">
    <input type="text" id="searchInput" placeholder="Search for a city, country or landmark..." autocomplete="off">
    <button onclick="searchLocation()">Explore</button>
  </div>

  <div id="loadingStatus">Loading location data...</div>
  <div id="infoBox"></div>

  <script>
    let viewer;
    let currentEntity = null;

    try {
      // Initialize Cesium Viewer with better default settings
      viewer = new Cesium.Viewer('cesiumContainer', {
        imageryProvider: new Cesium.UrlTemplateImageryProvider({
          url: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
          subdomains: ['a', 'b', 'c']
        }),
        baseLayerPicker: false,
        timeline: false,
        animation: false,
        sceneMode: Cesium.SceneMode.SCENE3D,
        shouldAnimate: true,
        skyAtmosphere: false,
        skyBox: false,
        selectionIndicator: false,
        homeButton: false,
        scene3DOnly: true,
        terrainProvider: Cesium.createWorldTerrain()
      });

      // Improve visual quality
      viewer.scene.globe.enableLighting = true;
      viewer.scene.fog.enabled = false;
      viewer.scene.highDynamicRange = true;
      viewer.scene.globe.depthTestAgainstTerrain = true;
      
      // Set initial view to whole Earth
      viewer.camera.setView({
        destination: Cesium.Cartesian3.fromDegrees(0, 0, 20000000),
        orientation: {
          heading: 0.0,
          pitch: -Cesium.Math.PI_OVER_TWO,
          roll: 0.0
        }
      });

      // Add event listener for Enter key in search input
      document.getElementById('searchInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          searchLocation();
        }
      });

    } catch (error) {
      document.getElementById('loadingStatus').style.display = 'block';
      document.getElementById('loadingStatus').textContent = 'Failed to load 3D map. Please check your connection.';
      console.error('Cesium initialization error:', error);
    }

    async function searchLocation() {
      const query = document.getElementById("searchInput").value.trim();
      const infoBox = document.getElementById("infoBox");
      const loadingStatus = document.getElementById("loadingStatus");

      if (!query) {
        infoBox.innerHTML = '<strong>Please enter a location to search</strong>';
        infoBox.style.display = 'block';
        setTimeout(() => { infoBox.style.display = 'none'; }, 2000);
        return;
      }

      loadingStatus.style.display = "block";
      loadingStatus.textContent = `Searching for "${query}"...`;

      try {
        // Clear previous entity if exists
        if (currentEntity) {
          viewer.entities.remove(currentEntity);
        }

        const response = await fetch(
          `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&addressdetails=1&limit=1`
        );
        
        if (!response.ok) throw new Error('Network response was not ok');
        
        const data = await response.json();
        
        if (!data.length) {
          loadingStatus.textContent = `Location not found: ${query}`;
          infoBox.style.display = "none";
          return;
        }

        const result = data[0];
        const lat = parseFloat(result.lat);
        const lon = parseFloat(result.lon);
        const displayName = result.display_name || query;
        const type = result.type || 'location';
        const address = result.address || {};

        // Create a pin at the location
        currentEntity = viewer.entities.add({
          name: displayName,
          position: Cesium.Cartesian3.fromDegrees(lon, lat),
          point: {
            pixelSize: 15,
            color: Cesium.Color.RED,
            outlineColor: Cesium.Color.WHITE,
            outlineWidth: 2
          },
          label: {
            text: displayName,
            font: '14pt sans-serif',
            style: Cesium.LabelStyle.FILL_AND_OUTLINE,
            outlineWidth: 2,
            verticalOrigin: Cesium.VerticalOrigin.BOTTOM,
            pixelOffset: new Cesium.Cartesian2(0, -10),
            fillColor: Cesium.Color.WHITE,
            outlineColor: Cesium.Color.BLACK
          }
        });

        // Fly to the location with smooth animation
        viewer.camera.flyTo({
          destination: Cesium.Cartesian3.fromDegrees(lon, lat, 2000),
          orientation: {
            heading: Cesium.Math.toRadians(0),
            pitch: Cesium.Math.toRadians(-45),
            roll: 0.0
          },
          duration: 2,
          complete: function() {
            loadingStatus.style.display = "none";
          }
        });

        // Prepare info box content
        let infoContent = `<strong>${displayName}</strong><br><small>${type}</small>`;
        
        if (address.country) {
          infoContent += `<br>Country: ${address.country}`;
        }
        if (address.city || address.town || address.village) {
          infoContent += `<br>Place: ${address.city || address.town || address.village}`;
        }
        
        infoContent += `
          <br><br>
          <a href="https://www.google.com/maps?q=${lat},${lon}" target="_blank" style="color: #4CAF50; text-decoration: none;">
            View on Google Maps üåç
          </a>
        `;

        infoBox.innerHTML = infoContent;
        infoBox.style.display = "block";

      } catch (error) {
        loadingStatus.textContent = "Error: Unable to complete the search";
        infoBox.innerHTML = `<strong>Error:</strong> ${error.message}`;
        infoBox.style.display = "block";
        console.error('Search error:', error);
      }
    }
  </script>
</body>
  </html>
